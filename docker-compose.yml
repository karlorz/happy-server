# docker-compose.yml for Coolify deployment
services:
    happy-server:
        image: happy-server:latest
        build:
            context: .
            dockerfile: Dockerfile
        restart: unless-stopped
        environment:
            # Application configuration
            - NODE_ENV=production
            - PORT=${PORT:-3000}

            # Coolify will populate this with your custom domain from UI
            - SERVICE_FQDN_HAPPY_SERVER_3000

            # Database connection - use service name, not localhost
            - DATABASE_URL=postgresql://${SERVICE_USER_POSTGRES:-postgres}:${SERVICE_PASSWORD_POSTGRES:?}@postgres:5432/${POSTGRES_DB:-happy-server}

            # Redis connection - use service name, not localhost
            - REDIS_URL=redis://redis:6379

            # Security - required field with no default (must be set in Coolify UI)
            - HANDY_MASTER_SECRET=${HANDY_MASTER_SECRET:?}

            # MinIO/S3 Storage configuration
            - S3_HOST=minio
            - S3_PORT=9000
            - S3_USE_SSL=false
            - S3_ACCESS_KEY=${SERVICE_USER_MINIO:-minioadmin}
            - S3_SECRET_KEY=${SERVICE_PASSWORD_MINIO:?}
            - S3_BUCKET=${S3_BUCKET:-happy-server}
            # You must set this in Coolify UI manually
            # Format: https://your-minio-domain.domain.com/happy-server
            - S3_PUBLIC_URL=${S3_PUBLIC_URL:?}
        ports:
            - "127.0.0.1:3005:3000" 
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            minio:
                condition: service_started
            minio-init:
                condition: service_completed_successfully
        # Run migrations before starting the server
        command: sh -c "npx prisma migrate deploy --schema /app/prisma/schema.prisma && yarn start"
        healthcheck:
            test: ["CMD-SHELL", "wget -q -O - http://localhost:3000/health || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    postgres:
        image: postgres:15
        restart: unless-stopped
        environment:
            - POSTGRES_DB=${POSTGRES_DB:-happy-server}
            - POSTGRES_USER=${SERVICE_USER_POSTGRES:-postgres}
            - POSTGRES_PASSWORD=${SERVICE_PASSWORD_POSTGRES:?}
            - TZ=Asia/Shanghai
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB} -h localhost"]
            interval: 30s
            timeout: 10s
            retries: 10
            start_period: 10s

    redis:
        image: redis:7-alpine
        restart: unless-stopped
        volumes:
            - redis_data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 30s
            timeout: 3s
            retries: 5
            start_period: 5s

    minio:
        image: minio/minio:latest
        restart: unless-stopped
        command: server /data --console-address ":9001"
        environment:
            MINIO_ROOT_USER: ${SERVICE_USER_MINIO:-minioadmin}
            MINIO_ROOT_PASSWORD: ${SERVICE_PASSWORD_MINIO:?}
            # Coolify will set these up based on domains you configure in UI
            # Port 9000: For file access (e.g., files.domain.com)
            # Port 9001: For admin console (e.g., minio-console.domain.com)
            SERVICE_FQDN_MINIO_9000: ""
            SERVICE_FQDN_MINIO_9001: ""
        volumes:
            - minio_data:/data

    # Automatically creates bucket and sets public download permission
    minio-init:
        image: minio/mc:latest
        exclude_from_hc: true  # Exclude from health checks - one-time init container
        depends_on:
            minio:
                condition: service_started
        entrypoint: ["sh", "-c"]
        environment:
            MINIO_ROOT_USER: ${SERVICE_USER_MINIO:-minioadmin}
            MINIO_ROOT_PASSWORD: ${SERVICE_PASSWORD_MINIO:?}
            S3_BUCKET: ${S3_BUCKET:-happy-server}
        command:
            - >
                echo "[minio-init] Waiting for MinIO to be ready...";
                sleep 10;
                for i in 1 2 3 4 5 6 7 8 9 10; do
                  echo "[minio-init] Attempt $i: Setting up alias...";
                  if mc alias set local http://minio:9000 "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD" 2>/dev/null; then
                    echo "[minio-init] Alias set successfully!";
                    break;
                  fi;
                  echo "[minio-init] MinIO not ready yet, waiting 5s...";
                  sleep 5;
                done &&
                echo "[minio-init] Verifying MinIO is ready...";
                mc ready local &&
                echo "[minio-init] Creating bucket: $S3_BUCKET";
                mc mb -p local/$S3_BUCKET || true &&
                echo "[minio-init] Setting anonymous download permission";
                mc anonymous set download local/$S3_BUCKET || true &&
                echo "[minio-init] Initialization complete!"
        restart: "no"

volumes:
    postgres_data:
    redis_data:
    minio_data:
